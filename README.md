# MLF (Minimun Letter Flip)
このリポジトリでは，グラフ彩色を用いて多倍体ゲノムをハプロタイプ別に分類し，各ハプロタイプを再構築するソフトウェアを公開しています．

## 用語集
- ゲノム  
ある生物が持つ全遺伝情報．
- 染色体  
遺伝情報を担う生体物質．ヒトの場合，1つの細胞につき46本の染色体が存在する．
- 塩基配列  
各染色体を構成するDNAの塩基部分の配列．A(アデニン), T(チミン), G(グアニン), C(シトシン)の4つのアルファベットからなる文字列で表現される．ヒトの場合，全部で長さ $3.0\times 10^9$ の文字列になる．
- 倍数性 (ploidy)  
染色体のセット数のこと．例えばヒトの場合，22本の常染色体を2セット，性染色体を2本持つため，2倍体である．ここでは，3倍体以上の生物のことを多倍体と呼ぶことにする．
- ハプロタイプ (haplotype)  
染色体の各セット別の配列のこと．例えばヒトの1番染色体のある領域を読んだ際，"ATTCA"と"GTTCA"という2つの結果が出てきたとすると，これらがハプロタイプとなる．ところが，ゲノム配列を読む際には 0.01 ~ 1 %の確率でエラーが入る可能性があり，多数決で簡単に決まるわけではない．また，短い配列の寄せ集めでハプロタイプを復元するという難しさがある．
- リード (read)  
ゲノム解析装置(シーケンサー)で読まれた配列のこと．シーケンサーが各染色体を端から端まで途切れずに読むことはなく，100 ~ 100000 塩基などのサイズで断片的に読む．
- SNP  
ハプロタイプ間で配列が大きく異なることは稀である．そこで，ハプロタイプ間で塩基が異なる部分のみが取り出されて解析されることが多い．この部分をSNP (Single Nucleotide Polymorphism, 一塩基多型)という．このリポジトリ内のデータでは，SNPのみを取り出してアレル行列という形で問題を表現している．

## データの説明
データはdataディレクトリに格納されている．フォーマットは以下の通りである．
- 倍数性
- リード数
- SNP数
- アレル行列 (各行がリード，各列がSNPに対応する．各要素は -, 0, 1, 2, 3で，0 ~ 3 は A, C, G, Tに対応し，- はリードがそのSNPをカバーしていないことを表す)
- 正解の分類におけるエラー数 (このリポジトリにあるファイルでは無視して良い)
- 各リードの正解の分類を表す配列
- 正解のハプロタイプ

リポジトリ内にあるデータは以下の6種類である．
| 倍数性  | リード数 r | SNP数 s |
| ----- | --------- | ------- |
|   4   |    100    |    57   |
|   4   |    100    |    30   |
|   8   |    100    |    48   |
|   8   |    100    |    23   |
|   16  |    100    |    33   |
|   16  |    100    |    13   |

## 各ソースファイルの説明
main.pyに関わるファイルのみ説明する．各ファイルには適宜コメントを付している．
- main.py  
dataディレクトリにある各データに対し，リードの分類とハプロタイプの推定を行う．
- open_file_for_polyploid.py  
上で指定したフォーマットに合うデータのみを読んで，各パラメータを取り出す．
- build_graph.py  
分類問題をグラフ彩色問題で定式化するにあたり，グラフを構築する．グラフGは十分にオーバーラップしているリード間の相違度を表現した重みつきグラフ，Hは十分にオーバーラップしているリード間の塩基が全て同じならば同じ連結成分に含まれるようなグラフ，Iは各リード間のハミング距離が重みとなっている重みつきグラフである．
- bfs_coloring.py  
幅優先探索(BFS)で次数最大の頂点を始点として,初期解(初期彩色)を作成する．
- color_annealing.py  
焼きなまし法でグラフ彩色のコストを下げていく．
- reconstruct_hap.py  
焼きなましで得られた分類をもとに，色別に各SNPで多数決を行い，ハプロタイプを再構築する．入力で与えられた正解のハプロタイプと再構築したハプロタイプを比較し，その類似度を表すヒートマップを作成する．

## 実行
まず，リポジトリをcloneし，作業ディレクトリに移動する．
```
  $ git clone https://github.com/teaparty2213/MLF.git
  $ cd ./MLF
```
次に，仮想環境を有効化する．仮想環境はvenvで作成してあり，リポジトリ内にすでに含まれている．
```
  $ . ./bin/activate
```
src内のmain.pyを実行することでリードの分類とハプロタイプの再構築が全て完了する．
```
  $ python ./src/main.py
```
出力には以下の内容が表示されます．
- 処理しているファイル名
- 焼きなましの経過(繰り返し回数，コスト，温度)
- データのハプロタイプ数，レード数，SNP数
- 近似比 (出力コスト / 正解の分類をグラフにしたときのコスト)
- 実行時間

一例
```
./data/4-ploid_r=100_s=30.txt
iteration:  25 cost:  663 T:  818.7626549625587
iteration:  50 cost:  385 T:  58.778806239486016
iteration:  75 cost:  288 T:  4.219718671825635
iteration:  100 cost:  216 T:  0.3029327543129362
iteration:  125 cost:  216 T:  0.02174748147272074
iteration:  150 cost:  216 T:  0.0015612473186632078
iteration:  175 cost:  216 T:  0.0001120816308357618
ploidy: 4, number of reads: 100, number of SNP positions: 30
approx ratio: 5.142857142857143
running time: 0.15739195901551284
```

resultディレクトリに，各データのコストの推移と，再構築したハプロタイプと正解の近さを評価したヒートマップが保存されます．

![4-ploid_r=100_s=30_cost](https://github.com/user-attachments/assets/c915f97a-e674-4c0a-89a4-5e38eeaac9a5)

![4-ploid_r=100_s=30_eval](https://github.com/user-attachments/assets/267c16cd-3f13-4969-b2e0-5fad6c1d1d7e)
